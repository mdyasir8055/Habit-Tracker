<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses - Life Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Income and Expense color styles */
        .expense-amount.income {
            color: #10b981; /* Green color for income */
            font-weight: bold;
        }
        
        .expense-amount.expense {
            color: #ef4444; /* Red color for expenses */
            font-weight: bold;
        }
    </style>
</head>
<body class="dark">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle">üåô</button>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="sparkle">‚ú®</span>
                <h1>Life Manager</h1>
            </div>
            <div class="nav-links">
                <a href="{{ url_for('home') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('expenses_page') }}" class="nav-link active">Expenses</a>
                <a href="{{ url_for('habits_page') }}" class="nav-link">Habits</a>
                <a href="{{ url_for('water_page') }}" class="nav-link">Water Tracker</a>
                <a href="{{ url_for('notes_page') }}" class="nav-link">Notes</a>
                <a href="{{ url_for('community_page') }}" class="nav-link">Community</a>
                <a href="{{ url_for('profile') }}" class="nav-link">Profile</a>
                <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Canvas Backgrounds -->
    <canvas id="starsCanvas"></canvas>
    <canvas id="neonCanvas"></canvas>

    <!-- Main Content -->
    <div class="container">
        <header class="header">
            <h1>Expense Tracker</h1>
            <p>Track your expenses and manage your finances with ease.</p>
        </header>

        <!-- Data Visualization Section -->
        <div class="card">
            <div class="card-header">
                <h2>Expense Analytics</h2>
                <p>Visualize your spending patterns</p>
                <div class="card-actions">
                    <div class="filter-container">
                        <label for="chartPeriod">Period:</label>
                        <select id="chartPeriod">
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-container" id="customDateContainer" style="display: none;">
                        <label for="startDate">From:</label>
                        <input type="date" id="startDate">
                        <label for="endDate">To:</label>
                        <input type="date" id="endDate">
                        <button id="applyCustomDate" class="small-button">Apply</button>
                    </div>
                </div>
            </div>
            <div class="card-content">
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h3>Spending by Category</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <h3>Spending Over Time</h3>
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Spending:</span>
                        <span class="stat-value" id="totalSpending">$0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Average Daily:</span>
                        <span class="stat-value" id="averageDaily">$0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Highest Category:</span>
                        <span class="stat-value" id="highestCategory">None</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Highest Day:</span>
                        <span class="stat-value" id="highestDay">None</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Management Section -->
        <div class="card">
            <div class="card-header">
                <h2>Budget Management</h2>
                <p>Set and track your spending limits</p>
            </div>
            <div class="card-content">
                <div class="budget-overview">
                    <div class="budget-summary">
                        <h3>Monthly Budget</h3>
                        <div class="budget-progress">
                            <div class="budget-bar-container">
                                <div class="budget-bar" id="budgetBar"></div>
                            </div>
                            <div class="budget-numbers">
                                <span id="currentSpending">$0</span>
                                <span id="budgetLimit">of $0</span>
                            </div>
                        </div>
                    </div>
                    <div class="budget-actions">
                        <button id="setBudgetBtn" class="action-button">Set Budget</button>
                        <button id="viewBudgetDetailsBtn" class="action-button">View Details</button>
                    </div>
                </div>
                <div class="category-budgets" id="categoryBudgets">
                    <!-- Category budgets will be populated here -->
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Add Expense Form -->
            <div class="card">
                <div class="card-header">
                    <h2>Add New Expense</h2>
                    <p>Record your spending</p>
                </div>
                <div class="card-content">
                    <form id="expense-form" class="form">
                        <div class="form-group">
                            <label for="transaction-type">Transaction Type</label>
                            <div class="toggle-switch">
                                <input type="radio" id="expense-type" name="transaction-type" value="expense" checked>
                                <label for="expense-type">Expense</label>
                                <input type="radio" id="income-type" name="transaction-type" value="income">
                                <label for="income-type">Income</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="expense-description">Description</label>
                            <input type="text" id="expense-description" required placeholder="What did you spend on?">
                        </div>
                        <div class="form-group">
                            <label for="expense-amount">Amount</label>
                            <input type="number" id="expense-amount" required placeholder="How much?" step="0.01" min="0.01">
                        </div>
                        <div class="form-group" id="category-group">
                            <label for="expense-category">Category</label>
                            <select id="expense-category" required>
                                <option value="food">Food</option>
                                <option value="transportation">Transportation</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="utilities">Utilities</option>
                                <option value="shopping">Shopping</option>
                                <option value="health">Health</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" id="income-category-group" style="display: none;">
                            <label for="income-category">Income Category</label>
                            <select id="income-category" required>
                                <option value="salary">Salary</option>
                                <option value="freelance">Freelance</option>
                                <option value="investment">Investment</option>
                                <option value="gift">Gift</option>
                                <option value="refund">Refund</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expense-date">Date</label>
                            <input type="date" id="expense-date" required>
                        </div>
                        <div class="form-group">
                            <label for="isRecurring">Recurring Expense</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="isRecurring" name="isRecurring">
                                <label for="isRecurring" class="toggle-label"></label>
                            </div>
                        </div>
                        <div id="recurringOptions" class="form-group" style="display: none;">
                            <label for="recurringFrequency">Frequency</label>
                            <select id="recurringFrequency" name="recurringFrequency">
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <button type="submit" class="button">Add Expense</button>
                    </form>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2>Statistics</h2>
                    <p>Your spending overview</p>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-icon">üí∞</span>
                            <div>
                                <p class="stat-label">Total Expenses</p>
                                <p class="stat-value" id="total-expenses">$0.00</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üìä</span>
                            <div>
                                <p class="stat-label">This Month</p>
                                <p class="stat-value" id="month-expenses">$0.00</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üîù</span>
                            <div>
                                <p class="stat-label">Top Category</p>
                                <p class="stat-value" id="top-category">None</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üìÖ</span>
                            <div>
                                <p class="stat-label">Today</p>
                                <p class="stat-value" id="today-expenses">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expenses List -->
        <div class="card">
            <div class="card-header">
                <h2>Your Expenses</h2>
                <p id="expense-count">Total: 0 expenses</p>
            </div>
            <div class="card-content">
                <div class="tabs" id="category-tabs">
                    <button class="tab active" data-category="all">All</button>
                    <button class="tab" data-category="food">Food</button>
                    <button class="tab" data-category="transportation">Transportation</button>
                    <button class="tab" data-category="entertainment">Entertainment</button>
                    <button class="tab" data-category="utilities">Utilities</button>
                    <button class="tab" data-category="shopping">Shopping</button>
                    <button class="tab" data-category="health">Health</button>
                    <button class="tab" data-category="other">Other</button>
                </div>
                <div class="expenses-container" id="expenses-container">
                    <!-- Expenses will be loaded here -->
                    <p class="no-expenses">No expenses found</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        // Check for saved theme preference or default to dark
        const savedTheme = localStorage.getItem('theme') || 'dark';
        body.className = savedTheme;
        themeToggle.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        
        // Toggle theme
        themeToggle.addEventListener('click', () => {
            if (body.className === 'dark') {
                body.className = 'light';
                themeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'light');
            } else {
                body.className = 'dark';
                themeToggle.textContent = 'üåô';
                localStorage.setItem('theme', 'dark');
            }
        });
        
        // Canvas animations
        class StarsAnimation {
            constructor() {
                this.canvas = document.getElementById('starsCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.stars = [];
                this.resize();
                this.init();
                this.animate();
                
                window.addEventListener('resize', () => this.resize());
            }
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.init();
            }
            
            init() {
                this.stars = [];
                const numStars = Math.floor(this.canvas.width * this.canvas.height / 1000);
                
                for (let i = 0; i < numStars; i++) {
                    this.stars.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        radius: Math.random() * 1.5,
                        opacity: Math.random() * 0.5 + 0.5
                    });
                }
            }
            
            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.stars.forEach(star => {
                    this.ctx.beginPath();
                    this.ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    this.ctx.fill();
                    
                    // Twinkle effect
                    star.opacity += Math.random() * 0.01 - 0.005;
                    star.opacity = Math.max(0.5, Math.min(1, star.opacity));
                });
                
                requestAnimationFrame(() => this.animate());
            }
        }
        
        class NeonAnimation {
            constructor() {
                this.canvas = document.getElementById('neonCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.resize();
                this.init();
                this.animate();
                
                window.addEventListener('resize', () => this.resize());
            }
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.init();
            }
            
            init() {
                this.particles = [];
                const numParticles = 50;
                
                for (let i = 0; i < numParticles; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        size: Math.random() * 2 + 1,
                        speedX: Math.random() * 1 - 0.5,
                        speedY: Math.random() * 1 - 0.5,
                        color: this.getRandomColor()
                    });
                }
            }
            
            getRandomColor() {
                const colors = ['#9333ea', '#ec4899', '#10b981', '#3b82f6'];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.particles.forEach(particle => {
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.ctx.fillStyle = particle.color;
                    this.ctx.fill();
                    
                    // Move particles
                    particle.x += particle.speedX;
                    particle.y += particle.speedY;
                    
                    // Bounce off edges
                    if (particle.x < 0 || particle.x > this.canvas.width) {
                        particle.speedX *= -1;
                    }
                    
                    if (particle.y < 0 || particle.y > this.canvas.height) {
                        particle.speedY *= -1;
                    }
                });
                
                requestAnimationFrame(() => this.animate());
            }
        }
        
        // Expense Tracker Class
        class ExpenseTracker {
            constructor() {
                this.expenses = [];
                this.activeCategory = 'all';
                this.monthlyBudget = 2000; // Default budget
                
                // Initialize
                this.initEventListeners();
                this.loadExpenses();
                this.loadBudget();
                
                // Set default date to today
                document.getElementById('expense-date').valueAsDate = new Date();
            }
            
            initEventListeners() {
                // Form submission
                document.getElementById('expense-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addExpense();
                });
                
                // Transaction type toggle
                const expenseType = document.getElementById('expense-type');
                const incomeType = document.getElementById('income-type');
                const categoryGroup = document.getElementById('category-group');
                const incomeCategoryGroup = document.getElementById('income-category-group');
                
                expenseType.addEventListener('change', () => {
                    if (expenseType.checked) {
                        categoryGroup.style.display = 'block';
                        incomeCategoryGroup.style.display = 'none';
                        document.getElementById('expense-description').placeholder = 'What did you spend on?';
                    }
                });
                
                incomeType.addEventListener('change', () => {
                    if (incomeType.checked) {
                        categoryGroup.style.display = 'none';
                        incomeCategoryGroup.style.display = 'block';
                        document.getElementById('expense-description').placeholder = 'Source of income';
                    }
                });
                
                // Category tabs
                document.querySelectorAll('#category-tabs .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('#category-tabs .tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.activeCategory = tab.getAttribute('data-category');
                        this.renderExpenses();
                    });
                });
                
                // Chart period selector
                const chartPeriod = document.getElementById('chartPeriod');
                if (chartPeriod) {
                    chartPeriod.addEventListener('change', () => {
                        const customDateContainer = document.getElementById('customDateContainer');
                        if (chartPeriod.value === 'custom') {
                            customDateContainer.style.display = 'flex';
                        } else {
                            customDateContainer.style.display = 'none';
                            this.filterExpensesByPeriod(chartPeriod.value);
                        }
                    });
                }
                
                // Custom date range
                const applyCustomDate = document.getElementById('applyCustomDate');
                if (applyCustomDate) {
                    applyCustomDate.addEventListener('click', () => {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        
                        if (startDate && endDate) {
                            this.filterExpensesByDateRange(startDate, endDate);
                        } else {
                            alert('Please select both start and end dates');
                        }
                    });
                }
                
                // Recurring expense toggle
                const isRecurring = document.getElementById('isRecurring');
                if (isRecurring) {
                    isRecurring.addEventListener('change', () => {
                        const recurringOptions = document.getElementById('recurringOptions');
                        recurringOptions.style.display = isRecurring.checked ? 'block' : 'none';
                    });
                }
                
                // Budget management buttons
                const setBudgetBtn = document.getElementById('setBudgetBtn');
                if (setBudgetBtn) {
                    setBudgetBtn.addEventListener('click', () => {
                        const budget = prompt('Enter your monthly budget:', this.monthlyBudget.toString());
                        if (budget && !isNaN(parseFloat(budget))) {
                            const budgetValue = parseFloat(budget);
                            this.saveBudget(budgetValue);
                            alert(`Budget set to $${budgetValue.toFixed(2)}`);
                            this.updateBudgetDisplay();
                        }
                    });
                }
                
                const viewBudgetDetailsBtn = document.getElementById('viewBudgetDetailsBtn');
                if (viewBudgetDetailsBtn) {
                    viewBudgetDetailsBtn.addEventListener('click', () => {
                        const categoryBudgets = document.getElementById('categoryBudgets');
                        categoryBudgets.style.display = categoryBudgets.style.display === 'none' ? 'grid' : 'none';
                    });
                }
            }
            
            filterExpensesByPeriod(period) {
                let filteredExpenses = [...this.expenses];
                const now = new Date();
                
                if (period === 'month') {
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear;
                    });
                } else if (period === 'year') {
                    const currentYear = now.getFullYear();
                    
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getFullYear() === currentYear;
                    });
                }
                
                this.renderChartsWithData(filteredExpenses);
            }
            
            filterExpensesByDateRange(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59); // Include the entire end day
                
                const filteredExpenses = this.expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                
                this.renderChartsWithData(filteredExpenses);
            }
            
            renderChartsWithData(data) {
                // Store the original expenses
                const originalExpenses = this.expenses;
                
                // Temporarily set the filtered data
                this.expenses = data;
                
                // Render charts with the filtered data
                this.renderCharts();
                
                // Restore the original data
                this.expenses = originalExpenses;
            }
            
            async loadExpenses() {
                try {
                    const response = await fetch('/expenses/data');
                    if (response.ok) {
                        this.expenses = await response.json();
                        this.renderExpenses();
                        this.updateStats();
                        this.renderCharts();
                        this.updateBudgetDisplay();
                    } else {
                        console.error('Failed to load expenses');
                    }
                } catch (error) {
                    console.error('Error loading expenses:', error);
                }
            }
            
            loadBudget() {
                // Try to load budget from localStorage
                const savedBudget = localStorage.getItem('monthlyBudget');
                if (savedBudget) {
                    this.monthlyBudget = parseFloat(savedBudget);
                }
            }
            
            saveBudget(budget) {
                this.monthlyBudget = parseFloat(budget);
                localStorage.setItem('monthlyBudget', this.monthlyBudget.toString());
            }
            
            renderCharts() {
                this.renderCategoryChart();
                this.renderTimeChart();
                this.updateAnalyticsSummary();
            }
            
            renderCategoryChart() {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                
                // Filter only expenses (positive amounts)
                const onlyExpenses = this.expenses.filter(expense => 
                    expense.type === 'expense' || expense.amount > 0
                );
                
                // Limit to top 5 categories for better performance
                const categoryData = {};
                onlyExpenses.forEach(expense => {
                    const category = expense.category;
                    if (!categoryData[category]) {
                        categoryData[category] = 0;
                    }
                    categoryData[category] += Math.abs(expense.amount);
                });
                
                // Sort categories by amount and take top 5
                const sortedCategories = Object.entries(categoryData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                // Prepare data for chart
                const labels = sortedCategories.map(item => item[0]);
                const data = sortedCategories.map(item => item[1]);
                
                // Define colors for categories
                const categoryColors = {
                    'food': '#10b981',
                    'transportation': '#3b82f6',
                    'entertainment': '#ec4899',
                    'utilities': '#f59e0b',
                    'shopping': '#8b5cf6',
                    'health': '#ef4444',
                    'other': '#6b7280'
                };
                
                const colors = labels.map(label => categoryColors[label] || '#6b7280');
                
                // Destroy previous chart if it exists to prevent memory leaks
                if (this.categoryChart) {
                    this.categoryChart.destroy();
                }
                
                // Create new chart
                this.categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500 // Faster animations
                        },
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: document.body.className === 'dark' ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.7)',
                                    font: {
                                        family: 'Inter',
                                        size: 10 // Smaller font
                                    },
                                    boxWidth: 10 // Smaller legend boxes
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            }
            
            renderTimeChart() {
                const ctx = document.getElementById('timeChart').getContext('2d');
                
                // Filter only expenses (positive amounts)
                const onlyExpenses = this.expenses.filter(expense => 
                    expense.type === 'expense' || expense.amount > 0
                );
                
                // Group expenses by date and limit to last 10 days for better performance
                const timeData = {};
                const sortedExpenses = [...onlyExpenses].sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Get only the last 10 days with data
                const uniqueDates = [...new Set(sortedExpenses.map(e => e.date.split('T')[0]))];
                const lastDates = uniqueDates.slice(-10); // Get last 10 days
                
                sortedExpenses.forEach(expense => {
                    const date = expense.date.split('T')[0];
                    if (lastDates.includes(date)) {
                        if (!timeData[date]) {
                            timeData[date] = 0;
                        }
                        timeData[date] += Math.abs(expense.amount);
                    }
                });
                
                // Format dates to be more readable
                const formattedTimeData = {};
                for (const [date, amount] of Object.entries(timeData)) {
                    const formattedDate = new Date(date).toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
                    formattedTimeData[formattedDate] = amount;
                }
                
                // Prepare data for chart
                const labels = Object.keys(formattedTimeData);
                const data = Object.values(formattedTimeData);
                
                // Destroy previous chart if it exists to prevent memory leaks
                if (this.timeChart) {
                    this.timeChart.destroy();
                }
                
                // Create new chart
                this.timeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Spending',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 500 // Faster animations
                        },
                        scales: {
                            x: {
                                grid: {
                             display: false // Hide grid lines for better performance
                                       },
                                ticks: {
                                    color: document.body.className === 'dark' ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)',
                                    maxRotation: 30,
                                    minRotation: 30,
                                    font: {
                                        size: 10 // Smaller font
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: document.body.className === 'dark' ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                                    tickBorderDash: [2, 2]
                                },
                                ticks: {
                                    color: document.body.className === 'dark' ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)',
                                    callback: (value) => '$' + value,
                                    font: {
                                        size: 10 // Smaller font
                                    },
                                    maxTicksLimit: 5 // Limit number of ticks for better performance
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        return `$${context.raw.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            updateAnalyticsSummary() {
                // Filter only expenses (positive amounts)
                const onlyExpenses = this.expenses.filter(expense => 
                    expense.type === 'expense' || expense.amount > 0
                );
                
                // Calculate total spending
                const totalSpending = onlyExpenses.reduce((sum, expense) => sum + Math.abs(expense.amount), 0);
                document.getElementById('totalSpending').textContent = this.formatCurrency(totalSpending);
                
                // Calculate average daily spending
                const dates = [...new Set(onlyExpenses.map(expense => expense.date.split('T')[0]))];
                const averageDaily = dates.length > 0 ? totalSpending / dates.length : 0;
                document.getElementById('averageDaily').textContent = this.formatCurrency(averageDaily);
                
                // Find highest category
                const categoryTotals = {};
                onlyExpenses.forEach(expense => {
                    if (!categoryTotals[expense.category]) {
                        categoryTotals[expense.category] = 0;
                    }
                    categoryTotals[expense.category] += Math.abs(expense.amount);
                });
                
                let highestCategory = 'None';
                let highestAmount = 0;
                
                for (const category in categoryTotals) {
                    if (categoryTotals[category] > highestAmount) {
                        highestAmount = categoryTotals[category];
                        highestCategory = category;
                    }
                }
                
                document.getElementById('highestCategory').textContent = highestCategory !== 'None' ? 
                    `${highestCategory} (${this.formatCurrency(highestAmount)})` : 'None';
                
                // Find highest spending day
                const dailyTotals = {};
                onlyExpenses.forEach(expense => {
                    const date = expense.date.split('T')[0];
                    if (!dailyTotals[date]) {
                        dailyTotals[date] = 0;
                    }
                    dailyTotals[date] += Math.abs(expense.amount);
                });
                
                let highestDay = 'None';
                let highestDayAmount = 0;
                
                for (const date in dailyTotals) {
                    if (dailyTotals[date] > highestDayAmount) {
                        highestDayAmount = dailyTotals[date];
                        highestDay = date;
                    }
                }
                
                if (highestDay !== 'None') {
                    const formattedDate = new Date(highestDay).toLocaleDateString();
                    document.getElementById('highestDay').textContent = 
                        `${formattedDate} (${this.formatCurrency(highestDayAmount)})`;
                } else {
                    document.getElementById('highestDay').textContent = 'None';
                }
            }
            
            updateBudgetDisplay() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                // Filter only expenses (positive amounts)
                const onlyExpenses = this.expenses.filter(expense => 
                    expense.type === 'expense' || expense.amount > 0
                );
                
                // Calculate current month's spending
                const monthlySpending = onlyExpenses
                    .filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, expense) => sum + Math.abs(expense.amount), 0);
                
                // Update budget progress bar
                const percentage = Math.min(100, (monthlySpending / this.monthlyBudget) * 100);
                const budgetBar = document.getElementById('budgetBar');
                budgetBar.style.width = `${percentage}%`;
                
                // Add warning class if over 80% of budget
                if (percentage > 80) {
                    budgetBar.classList.add('warning');
                } else {
                    budgetBar.classList.remove('warning');
                }
                
                // Update budget text
                document.getElementById('currentSpending').textContent = this.formatCurrency(monthlySpending);
                document.getElementById('budgetLimit').textContent = `of ${this.formatCurrency(this.monthlyBudget)}`;
                
                // Update category budgets
                this.updateCategoryBudgets();
            }
            
            updateCategoryBudgets() {
                // Calculate category budgets as a percentage of the total budget
                const categoryBudgets = {
                    'food': this.monthlyBudget * 0.25, // 25% of budget
                    'transportation': this.monthlyBudget * 0.15, // 15% of budget
                    'entertainment': this.monthlyBudget * 0.10, // 10% of budget
                    'utilities': this.monthlyBudget * 0.20, // 20% of budget
                    'shopping': this.monthlyBudget * 0.15, // 15% of budget
                    'health': this.monthlyBudget * 0.10, // 10% of budget
                    'other': this.monthlyBudget * 0.05 // 5% of budget
                };
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                // Filter only expenses (positive amounts)
                const onlyExpenses = this.expenses.filter(expense => 
                    expense.type === 'expense' || expense.amount > 0
                );
                
                // Calculate current month's spending by category
                const categorySpending = {};
                onlyExpenses
                    .filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear;
                    })
                    .forEach(expense => {
                        if (!categorySpending[expense.category]) {
                            categorySpending[expense.category] = 0;
                        }
                        categorySpending[expense.category] += Math.abs(expense.amount);
                    });
                
                // Define colors for categories
                const categoryColors = {
                    'food': '#10b981',
                    'transportation': '#3b82f6',
                    'entertainment': '#ec4899',
                    'utilities': '#f59e0b',
                    'shopping': '#8b5cf6',
                    'health': '#ef4444',
                    'other': '#6b7280'
                };
                
                // Generate category budget items
                const categoryBudgetsContainer = document.getElementById('categoryBudgets');
                categoryBudgetsContainer.innerHTML = '';
                
                for (const category in categoryBudgets) {
                    const budget = categoryBudgets[category];
                    const spent = categorySpending[category] || 0;
                    const percentage = Math.min(100, (spent / budget) * 100);
                    
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'category-budget-item';
                    
                    categoryEl.innerHTML = `
                        <div class="category-budget-header">
                            <div class="category-budget-icon" style="background-color: ${categoryColors[category]}20;">
                                ${this.getCategoryIcon(category)}
                            </div>
                            <div class="category-budget-name">${category}</div>
                        </div>
                        <div class="category-budget-bar-container">
                            <div class="category-budget-bar" style="width: ${percentage}%; background-color: ${categoryColors[category]};"></div>
                        </div>
                        <div class="category-budget-numbers">
                            <span>${this.formatCurrency(spent)}</span>
                            <span>of ${this.formatCurrency(budget)}</span>
                        </div>
                    `;
                    
                    categoryBudgetsContainer.appendChild(categoryEl);
                }
            }
            
            getCategoryIcon(category) {
                const icons = {
                    'food': 'üçî',
                    'transportation': 'üöó',
                    'entertainment': 'üé¨',
                    'utilities': 'üí°',
                    'shopping': 'üõçÔ∏è',
                    'health': 'üíä',
                    'other': 'üì¶'
                };
                
                return icons[category] || 'üì¶';
            }
            
            async addExpense() {
                const description = document.getElementById('expense-description').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const date = document.getElementById('expense-date').value;
                const transactionType = document.getElementById('expense-type').checked ? 'expense' : 'income';
                
                // Get the appropriate category based on transaction type
                let category;
                if (transactionType === 'expense') {
                    category = document.getElementById('expense-category').value;
                } else {
                    category = document.getElementById('income-category').value;
                }
                
                if (!description || isNaN(amount) || amount <= 0 || !category || !date) {
                    alert('Please fill in all fields correctly');
                    return;
                }
                
                const newExpense = {
                    description,
                    amount,
                    category,
                    date,
                    type: transactionType
                };
                
                try {
                    const response = await fetch('/expenses/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newExpense)
                    });
                    
                    if (response.ok) {
                        const savedExpense = await response.json();
                        this.expenses.push(savedExpense);
                        this.renderExpenses();
                        this.updateStats();
                        
                        // Reset form
                        document.getElementById('expense-form').reset();
                        document.getElementById('expense-date').valueAsDate = new Date();
                    } else {
                        console.error('Failed to add expense');
                    }
                } catch (error) {
                    console.error('Error adding expense:', error);
                }
            }
            
            async deleteExpense(id) {
                if (!confirm('Are you sure you want to delete this expense?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/expenses/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.expenses = this.expenses.filter(expense => expense.id !== id);
                        this.renderExpenses();
                        this.updateStats();
                    } else {
                        console.error('Failed to delete expense');
                    }
                } catch (error) {
                    console.error('Error deleting expense:', error);
                }
            }
            
            renderExpenses() {
                const container = document.getElementById('expenses-container');
                container.innerHTML = '';
                
                const filteredExpenses = this.activeCategory === 'all'
                    ? this.expenses
                    : this.expenses.filter(e => e.category === this.activeCategory);
                
                // Sort by date (newest first)
                filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (filteredExpenses.length === 0) {
                    container.innerHTML = '<p class="no-expenses">No expenses found</p>';
                } else {
                    filteredExpenses.forEach(expense => {
                        const expenseElement = document.createElement('div');
                        expenseElement.className = 'expense-item';
                        
                        // Determine if it's an expense or income
                        const isIncome = expense.type === 'income' || expense.amount < 0;
                        
                        // Format date
                        const date = new Date(expense.date);
                        const formattedDate = date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                        
                        // Format amount (absolute value for display)
                        const amountValue = Math.abs(expense.amount);
                        const formattedAmount = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD'
                        }).format(amountValue);
                        
                        // Get category icon
                        const categoryIcon = this.getCategoryIcon(expense.category);
                        
                        expenseElement.innerHTML = `
                            <div class="expense-content">
                                <div class="expense-category-icon ${expense.category}">
                                    ${categoryIcon}
                                </div>
                                <div class="expense-info">
                                    <p class="expense-description">${expense.description}</p>
                                    <p class="expense-meta">
                                        ${formattedDate} ‚Ä¢ ${expense.category} ‚Ä¢ ${isIncome ? 'Income' : 'Expense'}
                                    </p>
                                </div>
                                <div class="expense-amount ${isIncome ? 'income' : 'expense'}">
                                    ${isIncome ? '+' : ''}${formattedAmount}
                                </div>
                                <button class="delete-button" 
                                        onclick="expenseTracker.deleteExpense('${expense.id}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `;
                        container.appendChild(expenseElement);
                    });
                }
                
                // Update expense count
                document.getElementById('expense-count').textContent = `Total: ${filteredExpenses.length} transaction${filteredExpenses.length !== 1 ? 's' : ''}`;
            }
            
            getCategoryIcon(category) {
                const icons = {
                    food: 'üçî',
                    transportation: 'üöó',
                    entertainment: 'üé¨',
                    utilities: 'üí°',
                    shopping: 'üõçÔ∏è',
                    health: 'üè•',
                    other: 'üìù'
                };
                
                return icons[category] || 'üìù';
            }
            
            updateStats() {
                // Filter only expenses (positive amounts) and income (negative amounts)
                const onlyExpenses = this.expenses.filter(expense => 
                    expense.type === 'expense' || expense.amount > 0
                );
                const onlyIncome = this.expenses.filter(expense => 
                    expense.type === 'income' || expense.amount < 0
                );
                
                // Calculate total expenses (positive values)
                const totalExpenses = onlyExpenses.reduce((sum, expense) => sum + Math.abs(expense.amount), 0);
                // Calculate total income (negative values stored as positive for display)
                const totalIncome = onlyIncome.reduce((sum, expense) => sum + Math.abs(expense.amount), 0);
                // Net amount (income - expenses)
                const netAmount = totalIncome - totalExpenses;
                
                // Display total expenses
                document.getElementById('total-expenses').textContent = this.formatCurrency(totalExpenses);
                
                // Calculate this month's expenses
                const now = new Date();
                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();
                
                const monthExpenses = onlyExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === thisMonth && expenseDate.getFullYear() === thisYear;
                }).reduce((sum, expense) => sum + Math.abs(expense.amount), 0);
                
                document.getElementById('month-expenses').textContent = this.formatCurrency(monthExpenses);
                
                // Calculate today's expenses
                const today = new Date().toISOString().split('T')[0];
                const todayExpenses = onlyExpenses
                    .filter(expense => expense.date === today)
                    .reduce((sum, expense) => sum + Math.abs(expense.amount), 0);
                
                document.getElementById('today-expenses').textContent = this.formatCurrency(todayExpenses);
                
                // Find top expense category
                const categories = {};
                onlyExpenses.forEach(expense => {
                    if (!categories[expense.category]) {
                        categories[expense.category] = 0;
                    }
                    categories[expense.category] += Math.abs(expense.amount);
                });
                
                let topCategory = 'None';
                let topAmount = 0;
                
                for (const category in categories) {
                    if (categories[category] > topAmount) {
                        topAmount = categories[category];
                        topCategory = category.charAt(0).toUpperCase() + category.slice(1);
                    }
                }
                
                document.getElementById('top-category').textContent = topCategory;
            }
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            }
        }
        
        // Initialize everything
        const starsAnimation = new StarsAnimation();
        const neonAnimation = new NeonAnimation();
        const expenseTracker = new ExpenseTracker();
    </script>
</body>
</html>